# =========================================================
# TH8 Sense DCC — Policy YAML (Enterprise v1)
# Multi-domain, deterministic, audit-ready
# =========================================================

meta:
  policy_id: TH8-Sense
  version: v1.0
  description: >
    Enterprise policy. Deterministic. Evidence-first. Multi-domain.
  defaults:
    currency: THB
    rounding:
      money_decimals: 2
      pct_decimals: 2
    tolerances:
      qty_abs: 0
      qty_pct: 0
      price_abs: 0
      price_pct: 0
      amount_pct: 0.0

  discovery:
    min_relational_docs: 3
    enable_vector_backfill: true
    vector_min_similarity: 0.42
    vector_top_k_chunks: 50
    vector_top_k_docs: 15
    vector_top_chunks_per_doc: 3
    vector_max_inferred_docs: 12
    contract_guard_mode: "STRICT"

domains:

  procurement:
    description: Procurement decision control
    profile:
      baseline_priority:
        - T_CONTRACT_MIN_PRICE
        - T_CONTRACT_DIRECT_PRICE
        - T_LAST_OBSERVED_PRICE
        - T_MEDIAN_12M_PRICE
        - T_NO_BASELINE_ESCALATE

    calculations:
      variance_pct:
        description: Percent variance between PO unit price and baseline price
        unit: PERCENT
        formula_id: PCT_DIFF
        inputs:
          po_unit_price_value: "$po.unit_price.value"
          baseline_price_value: "$selection.baseline.value"
        guards:
          - not_null: ["po_unit_price_value", "baseline_price_value"]
          - non_zero: ["baseline_price_value"]
        output:
          field: "variance_pct"
          rounding: pct_decimals

      contract_breach:
        description: PO price higher than baseline (contract)
        unit: BOOLEAN
        formula_id: GT
        inputs:
          left_value: "$po.unit_price.value"
          right_value: "$selection.baseline.value"
        guards:
          - not_null: ["left_value", "right_value"]
        output:
          field: "contract_breach"

    techniques:
      - id: T_CONTRACT_MIN_PRICE
        category: BASELINE
        description: Use minimum contract price as baseline
        required_facts: [CONTRACT_PRICE]
        gates:
          currency_match: true
          min_confidence:
            evidence_type: PRICE
            threshold: 0.75

      - id: T_CONTRACT_DIRECT_PRICE
        category: BASELINE
        description: Use direct contract price as baseline
        required_facts: [CONTRACT_PRICE]
        gates:
          currency_match: true
          min_confidence:
            evidence_type: PRICE
            threshold: 0.70

      - id: T_LAST_OBSERVED_PRICE
        category: BASELINE
        description: Use last observed purchase price as baseline
        required_facts: [LAST_PRICE]
        gates:
          currency_match: true

      - id: T_MEDIAN_12M_PRICE
        category: BASELINE
        description: Use median price of last 12 months as baseline
        required_facts: [MEDIAN_12M_PRICE]
        gates:
          currency_match: true

      - id: T_NO_BASELINE_ESCALATE
        category: FALLBACK
        description: No reliable baseline available
        outcome:
          readiness_flag: baseline_available=false
          required_action: REVIEW

    rules:
      - rule_id: P-PRICE-01
        group: PRICE
        severity: MED
        description: Price variance vs selected baseline
        preconditions:
          baseline_available: true
        uses: ["variance_pct"]
        logic:
          type: compare
          field: variance_pct
          operator: ">"
          value: 3
        fail_actions:
          - REVIEW
        explanation:
          exec: "ราคาขอซื้อสูงกว่าราคาฐานเกินเกณฑ์"
          audit: "PO variance {variance_pct}% exceeds threshold 3%"

      - rule_id: P-CONTRACT-01
        group: PRICE
        severity: HIGH
        description: Contract price breach
        preconditions:
          baseline_source: CONTRACT_PRICE
        uses: ["contract_breach"]
        logic:
          type: compare
          field: contract_breach
          operator: "=="
          value: true
        fail_actions:
          - REVIEW
        explanation:
          exec: "ราคาซื้อสูงกว่าราคาตามสัญญา"
          audit: "PO price exceeds contract baseline"

      - rule_id: P-DOC-01
        group: PROCESS
        severity: HIGH
        description: Required procurement documents
        preconditions: {}
        uses: []
        logic:
          type: document_presence
          required_docs: [CONTRACT, QUOTATION]
        fail_actions:
          - REVIEW
        explanation:
          exec: "เอกสารจัดซื้อไม่ครบ"
          audit: "Missing required documents: {missing_docs}"

domains:
  finance_ap:
    domain_id: FINANCE_AP
    title: "Finance AP 3-Way Matching"

    calculations:
      A-CALC-01:
        calc_id: A-CALC-01
        output_field: gr_exceeds_po
        formula_id: GT
        inputs:
          left_value: "$ap.over_gr_qty"
          right_value: 0

      A-CALC-02:
        calc_id: A-CALC-02
        output_field: inv_exceeds_gr
        formula_id: GT
        inputs:
          left_value: "$ap.over_inv_qty"
          right_value: 0

      A-CALC-03:
        calc_id: A-CALC-03
        output_field: inv_without_gr
        formula_id: GT
        inputs:
          left_value: "$ap.inv_without_gr_flag"
          right_value: 0

      A-CALC-04:
        calc_id: A-CALC-04
        output_field: dup_invoice
        formula_id: GT
        inputs:
          left_value: "$ap.dup_flag"
          right_value: 0

      A-CALC-05:
        calc_id: A-CALC-05
        output_field: price_within_tolerance
        formula_id: ABS_DIFF_LTE
        inputs:
          left_value: "$ap.inv_unit_price"
          right_value: "$ap.po_unit_price"
          expected_value: "$meta.defaults.tolerances.price_abs"

    rules:
      - rule_id: A-QTY-01
        group: QUANTITY
        severity: HIGH
        explanation:
          exec: "ยอดรับของมากกว่ายอด PO"
          audit: "GR exceeds PO sku={ap.sku} (qty_gr={ap.qty_gr}, qty_po={ap.qty_po}, over_gr_qty={ap.over_gr_qty})"
        logic:
          type: compare
          field: gr_exceeds_po
          operator: "=="
          value: false
        fail_actions:
          - type: REVIEW

      - rule_id: A-QTY-02
        group: QUANTITY
        severity: HIGH
        explanation:
          exec: "ยอดใบแจ้งหนี้มากกว่ายอดรับของ"
          audit: "INV exceeds GR sku={ap.sku} (qty_inv={ap.qty_inv}, qty_gr={ap.qty_gr}, over_inv_qty={ap.over_inv_qty})"
        logic:
          type: compare
          field: inv_exceeds_gr
          operator: "=="
          value: false
        fail_actions:
          - type: REVIEW

      - rule_id: A-PROCESS-01
        group: PROCESS
        severity: CRITICAL
        explanation:
          exec: "มีใบแจ้งหนี้แต่ยังไม่มีใบรับของ (GRN)"
          audit: "Invoice without GR sku={ap.sku} (qty_inv={ap.qty_inv}, qty_gr={ap.qty_gr})"
        logic:
          type: compare
          field: inv_without_gr
          operator: "=="
          value: false
        fail_actions:
          - type: ESCALATE

      - rule_id: A-PRICE-01
        group: PRICE
        severity: HIGH
        explanation:
          exec: "ราคาใบแจ้งหนี้ไม่ตรงกับ PO"
          audit: "Price mismatch sku={ap.sku} (inv={ap.inv_unit_price}, po={ap.po_unit_price}, tol_abs={meta.defaults.tolerances.price_abs})"
        logic:
          type: compare
          field: price_within_tolerance
          operator: "=="
          value: true
        fail_actions:
          - type: REVIEW

      - rule_id: A-FRAUD-01
        group: FRAUD
        severity: HIGH
        explanation:
          exec: "พบใบแจ้งหนี้ซ้ำ"
          audit: "Duplicate invoice (vendor={ap.vendor_id}, invoice={ap.invoice_number}, fp={ap.invoice_fp})"
        logic:
          type: compare
          field: dup_invoice
          operator: "=="
          value: false
        fail_actions:
          - type: REVIEW

decision_logic:
  outcomes:
    APPROVE:
      conditions:
        - no_fail_severity_greater_equal: HIGH
    REVIEW:
      conditions:
        - any_fail_severity_in: [MED, HIGH]
    REJECT:
      conditions:
        - any_fail_severity_equal: CRITICAL
